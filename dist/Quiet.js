!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Quiet=t():e.Quiet=t()}(self,(function(){return(()=>{"use strict";var e={d:(t,i)=>{for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Module:()=>i,Quiet:()=>u,ab2str:()=>n,mergeab:()=>a,str2ab:()=>o});const i={onRuntimeInitialized:function(){console.log("onRuntimeInitialized",...arguments)},locateFile:function(e,t){return console.log("locateFile",e,...arguments),t||(t="https://yunxin-g2-assets.oss-cn-hangzhou.aliyuncs.com/quiet-webrtc/"),t+e}};window.Module=i;let s=null,r=null;function n(e){return r||(r=new TextDecoder),r.decode(e)}function o(e){return s||(s=new TextEncoder),s.encode(e)}function a(e,t){var i=new Uint8Array(e.byteLength+t.byteLength);return i.set(new Uint8Array(e),0),i.set(new Uint8Array(t),e.byteLength),i.buffer}class c{constructor(e){this.inited=!1,this.samples=0,this.lastChecksumFailCount=0,this.last_consume_times=[],this.num_consume_times=0,this.sample_view=new Float32Array,this.idx=0,this.quiet=e.quiet,this.profile=e.profile,this.c_profiles=i.intArrayFromString(JSON.stringify({profile:this.profile})),this.c_profile=i.intArrayFromString("profile"),this.opts=e,this.opt=i.ccall("quiet_decoder_profile_str","pointer",["array","array"],[this.c_profiles,this.c_profile]),this.decoder=i.ccall("quiet_decoder_create","pointer",["pointer","number"],[this.opt,this.quiet.audioCtx.sampleRate]),this.audioStream=e.audioStream,this.audioInput=this.quiet.audioCtx.createMediaStreamSource(this.audioStream),this.audioDestination=this.quiet.audioCtx.createMediaStreamDestination(),this.scriptProcessor=this.initScriptProcessor(),this.audioInput.connect(this.scriptProcessor),this.scriptProcessor.connect(this.audioDestination),this.init()}init(){i.ccall("free",null,["pointer"],[this.opt]),this.samples=i.ccall("malloc","pointer",["number"],[4*this.quiet.sampleBufferSize]),this.frame=i.ccall("malloc","pointer",["number"],[this.quiet.frameBufferSize]),void 0!==this.opts.onReceiverStatsUpdate&&i.ccall("quiet_decoder_enable_stats",null,["pointer"],[this.decoder]),this.inited=!0,this.lastChecksumFailCount=0,this.last_consume_times=[],this.num_consume_times=3}readbuf(){if(this.inited)for(;;){var e=i.ccall("quiet_decoder_recv","number",["pointer","pointer","number"],[this.decoder,this.frame,this.quiet.frameBufferSize]);if(-1===e)break;const t=i.HEAP8.slice(this.frame,this.frame+e);this.opts.onReceive(t.buffer)}}consume(){if(!this.inited)return;const e=Date.now();i.ccall("quiet_decoder_consume","number",["pointer","pointer","number"],[this.decoder,this.samples,this.quiet.sampleBufferSize]);const t=Date.now();this.last_consume_times.unshift(t-e),this.last_consume_times.length>this.num_consume_times&&this.last_consume_times.pop(),window.setTimeout((()=>{this.readbuf()}),0);const s=i.ccall("quiet_decoder_checksum_fails","number",["pointer"],[this.decoder]);if(setTimeout((()=>{s>this.lastChecksumFailCount&&(this.lastChecksumFailCount=s,this.opts.onReceiveFail?this.opts.onReceiveFail(s):console.error("onReceiveFail",s))}),0),this.opts.onReceiverStatsUpdate){var r=i.ccall("malloc","pointer",["number"],[4]),n=i.ccall("quiet_decoder_consume_stats","pointer",["pointer","pointer"],[this.decoder,r]),o=i.HEAPU32[r/4];i.ccall("free",null,["pointer"],[r]);for(var a=[],c=0;c<o;c++){var l=(n+20*c)/4,u=i.HEAPU32[l],h=i.HEAPU32[l+1];const e={errorVectorMagnitude:i.HEAPF32[l+2],receivedSignalStrengthIndicator:i.HEAPF32[l+3],symbols:[]};for(var m=0;m<h;m++){var p=(u+8*m)/4;e.symbols.push({real:i.HEAPF32[p],imag:i.HEAPF32[p+1]})}a.push(e)}this.opts.onReceiverStatsUpdate(a)}}initScriptProcessor(){if(this.inited)throw new Error("Not inited");const e=this.quiet.audioCtx.createScriptProcessor(this.quiet.sampleBufferSize,2,1);return this.idx=this.quiet.receivers_idx,this.quiet.receivers[this.idx]=this.scriptProcessor,this.quiet.receivers_idx++,e.onaudioprocess=e=>{if(this.inited){var t=e.inputBuffer.getChannelData(0);this.sample_view=i.HEAPF32.subarray(this.samples/4,this.samples/4+this.quiet.sampleBufferSize),this.sample_view.set(t),window.setTimeout((()=>{this.consume()}),0)}},e}destroy(){this.inited&&(this.scriptProcessor.disconnect(),i.ccall("free",null,["pointer"],[this.samples]),i.ccall("free",null,["pointer"],[this.frame]),delete this.quiet.receivers[this.idx],this.inited=!1)}getAverageDecodeTime(){if(0===this.last_consume_times.length)return 0;for(var e=0,t=0;t<this.last_consume_times.length;t++)e+=this.last_consume_times[t];return e/this.last_consume_times.length}}class l{constructor(e){this.running=!1,this.inited=!0,this.played=!0,this.payload=[],this.samples=0,this.last_emit_times=[],this.num_emit_times=3,this.empties_written=0,this.opts=e,this.profileObj=e.profile,this.quiet=e.quiet,this.clampFrame=e.clampFrame,this.c_profiles=i.intArrayFromString(JSON.stringify({profile:this.profileObj})),this.c_profile=i.intArrayFromString("profile"),this.done=e.onFinish,this.opt=i.ccall("quiet_encoder_profile_str","pointer",["array","array"],[this.c_profiles,this.c_profile]),this.encoder=i.ccall("quiet_encoder_create","pointer",["pointer","number"],[this.opt,this.quiet.audioCtx.sampleRate]),i.ccall("free",null,["pointer"],[this.opt]),this.frame_len=0,this.clampFrame?this.frame_len=i.ccall("quiet_encoder_clamp_frame_len","number",["pointer","number"],[this.encoder,this.quiet.sampleBufferSize]):this.frame_len=i.ccall("quiet_encoder_get_frame_len","number",["pointer"],[this.encoder]),this.samples=i.ccall("malloc","pointer",["number"],[4*this.quiet.sampleBufferSize]),this.sample_view=i.HEAPF32.subarray(this.samples/4,this.samples/4+this.quiet.sampleBufferSize),this.scriptNode=this.quiet.audioCtx.createScriptProcessor(this.quiet.sampleBufferSize,1,2),this.scriptNode.onaudioprocess=e=>{const t=e.outputBuffer.getChannelData(0);if(this.played)for(let e=0;e<this.quiet.sampleBufferSize;e++)t[e]=0;else this.played=!0,t.set(this.sample_view)},this.dummy_osc=this.quiet.audioCtx.createOscillator(),this.dummy_osc.type="square",this.dummy_osc.frequency.value=420,this.mediaStreamDestination=this.quiet.audioCtx.createMediaStreamDestination(),this.stream=this.mediaStreamDestination.stream}transmit(e){if(this.inited){for(let t=0;t<e.byteLength;){const i=e.slice(t,t+this.frame_len);t+=i.byteLength,this.payload.push(i)}this.writebuf()}}transmitText(e){const t=o(e);return this.transmit(t)}startTransmitter(){this.inited&&(this.inited=!0,this.dummy_osc.connect(this.scriptNode),this.scriptNode.connect(this.mediaStreamDestination),this.running=!0)}writebuf(){if(!this.inited)return;let e=!1,t=!1;for(;;){const s=this.payload.shift();if(!s)break;if(e=!0,-1===i.ccall("quiet_encoder_send","number",["pointer","array","number"],[this.encoder,new Uint8Array(s),s.byteLength])){this.payload.unshift(s);break}t=!0}if(!this.payload.length&&t&&void 0!==this.opts.onEnqueue&&window.setTimeout(this.opts.onEnqueue,0),e&&!this.running&&this.startTransmitter(),!this.played)return;const s=Date.now(),r=i.ccall("quiet_encoder_emit","number",["pointer","pointer","number"],[this.encoder,this.samples,this.quiet.sampleBufferSize]),n=Date.now();if(this.last_emit_times.unshift(n-s),this.last_emit_times.length>this.num_emit_times&&this.last_emit_times.pop(),!e&&-1===r){if(this.empties_written<3){for(let e=0;e<this.quiet.sampleBufferSize;e++)this.sample_view[e]=0;return this.empties_written++,void(this.played=!1)}return void 0!==this.done&&this.done(),void(this.running&&this.stopTransmitter())}if(this.played=!1,this.empties_written=0,r<this.quiet.sampleBufferSize)for(let e=r;e<this.quiet.sampleBufferSize;e++)this.sample_view[e]=0}stopTransmitter(){this.inited&&(this.running=!1)}}class u{constructor(e){this.emscriptenInitialized=!1,this.inited=!1,this.profiles={},this.frameBufferSize=Math.pow(2,14),this.receivers={},this.receivers_idx=0,this.sampleBufferSize=16384,window.AudioContext?this.audioCtx=new AudioContext(e):this.audioCtx=new webkitAudioContext(e)}async init(e){this.profiles=e.profiles,this.inited=!0,this.resume(),await async function(){if("INITED"!==h)return new Promise((e=>{if(m.push(e),"UNINIT"===h){h="INITING";const e=Date.now(),t=document.createElement("script");t.async=!0,t.src=i.locateFile("quiet-emscripten.js"),document.body.appendChild(t),i.onRuntimeInitialized=function(){h="INITED",console.log("onRuntimeInitialized",Date.now()-e),m.forEach((e=>{e()}))}}}))}()}async resume(){"suspended"===this.audioCtx.state&&await this.audioCtx.resume()}async transmitter(e){const t=e.onEnqueue||function(){console.log("transmitter.onEnqueue",...arguments)},i=e.onFinish||function(){console.log("transmitter.onFinish",...arguments)},s=this.profiles[e.profileName];if(!s)throw new Error(`Cannot find profile [${e.profileName}]. Available profileNames: ${Object.keys(this.profiles).join()}`);const r={profile:s,quiet:this,clampFrame:e.clampFrame,onEnqueue:t,onFinish:i};return new l(r)}async receiver(e){const t=e.audioStream||await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),i=e.onReceive||function(t){console.log("onReceive",e.profileName,n(t))},s=this.profiles[e.profileName];if(!s)throw new Error(`Cannot find profile [${e.profileName}]. Available profileNames: ${Object.keys(this.profiles).join()}`);const r={profile:s,audioStream:t,quiet:this,onReceive:i,onReceiveFail:e.onReceiveFail,onReceiverStatsUpdate:e.onReceiverStatsUpdate};return r.quiet=this,new c(r)}}let h="UNINIT";const m=[];return t})()}));
//# sourceMappingURL=Quiet.js.map