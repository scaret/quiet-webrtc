!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Quiet=t():e.Quiet=t()}(self,(function(){return(()=>{"use strict";var e={729:e=>{var t=Object.prototype.hasOwnProperty,i="~";function s(){}function n(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function r(e,t,s,r,o){if("function"!=typeof s)throw new TypeError("The listener must be a function");var a=new n(s,r||e,o),c=i?i+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function a(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(i=!1)),a.prototype.eventNames=function(){var e,s,n=[];if(0===this._eventsCount)return n;for(s in e=this._events)t.call(e,s)&&n.push(i?s.slice(1):s);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},a.prototype.listeners=function(e){var t=i?i+e:e,s=this._events[t];if(!s)return[];if(s.fn)return[s.fn];for(var n=0,r=s.length,o=new Array(r);n<r;n++)o[n]=s[n].fn;return o},a.prototype.listenerCount=function(e){var t=i?i+e:e,s=this._events[t];return s?s.fn?1:s.length:0},a.prototype.emit=function(e,t,s,n,r,o){var a=i?i+e:e;if(!this._events[a])return!1;var c,l,h=this._events[a],u=arguments.length;if(h.fn){switch(h.once&&this.removeListener(e,h.fn,void 0,!0),u){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,t),!0;case 3:return h.fn.call(h.context,t,s),!0;case 4:return h.fn.call(h.context,t,s,n),!0;case 5:return h.fn.call(h.context,t,s,n,r),!0;case 6:return h.fn.call(h.context,t,s,n,r,o),!0}for(l=1,c=new Array(u-1);l<u;l++)c[l-1]=arguments[l];h.fn.apply(h.context,c)}else{var p,m=h.length;for(l=0;l<m;l++)switch(h[l].once&&this.removeListener(e,h[l].fn,void 0,!0),u){case 1:h[l].fn.call(h[l].context);break;case 2:h[l].fn.call(h[l].context,t);break;case 3:h[l].fn.call(h[l].context,t,s);break;case 4:h[l].fn.call(h[l].context,t,s,n);break;default:if(!c)for(p=1,c=new Array(u-1);p<u;p++)c[p-1]=arguments[p];h[l].fn.apply(h[l].context,c)}}return!0},a.prototype.on=function(e,t,i){return r(this,e,t,i,!1)},a.prototype.once=function(e,t,i){return r(this,e,t,i,!0)},a.prototype.removeListener=function(e,t,s,n){var r=i?i+e:e;if(!this._events[r])return this;if(!t)return o(this,r),this;var a=this._events[r];if(a.fn)a.fn!==t||n&&!a.once||s&&a.context!==s||o(this,r);else{for(var c=0,l=[],h=a.length;c<h;c++)(a[c].fn!==t||n&&!a[c].once||s&&a[c].context!==s)&&l.push(a[c]);l.length?this._events[r]=1===l.length?l[0]:l:o(this,r)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&o(this,t)):(this._events=new s,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=i,a.EventEmitter=a,e.exports=a}},t={};function i(s){var n=t[s];if(void 0!==n)return n.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,i),r.exports}i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};return(()=>{i.r(s),i.d(s,{Module:()=>e,Quiet:()=>u,ab2str:()=>r,mergeab:()=>a,str2ab:()=>o});const e={onRuntimeInitialized:function(){console.log("onRuntimeInitialized",...arguments)},locateFile:function(e,t){return console.log("locateFile",e,...arguments),t||(t="https://yunxin-g2-assets.oss-cn-hangzhou.aliyuncs.com/quiet-webrtc/"),t+e}};window.Module=e;let t=null,n=null;function r(e){return n||(n=new TextDecoder),n.decode(e)}function o(e){return t||(t=new TextEncoder),t.encode(e)}function a(e,t){var i=new Uint8Array(e.byteLength+t.byteLength);return i.set(new Uint8Array(e),0),i.set(new Uint8Array(t),e.byteLength),i.buffer}class c{constructor(t){this.inited=!1,this.samples=0,this.lastChecksumFailCount=0,this.last_consume_times=[],this.num_consume_times=0,this.sample_view=new Float32Array,this.idx=0,this.quiet=t.quiet,this.profile=t.profile,this.c_profiles=e.intArrayFromString(JSON.stringify({profile:this.profile})),this.c_profile=e.intArrayFromString("profile"),this.opts=t,this.opt=e.ccall("quiet_decoder_profile_str","pointer",["array","array"],[this.c_profiles,this.c_profile]),this.decoder=e.ccall("quiet_decoder_create","pointer",["pointer","number"],[this.opt,this.quiet.audioCtx.sampleRate]),this.audioDestination=this.quiet.audioCtx.createMediaStreamDestination(),this.scriptProcessor=this.initScriptProcessor(),this.audioStreams=t.audioStreams,this.audioInputs=[],this.audioStreams.forEach((e=>{this.addAudioStream(e)})),this.scriptProcessor.connect(this.audioDestination),this.init()}addAudioStream(e){const t=this.quiet.audioCtx.createMediaStreamSource(e);this.audioInputs.push(t),-1===this.audioStreams.indexOf(e)&&this.audioStreams.push(e),t.connect(this.scriptProcessor)}init(){e.ccall("free",null,["pointer"],[this.opt]),this.samples=e.ccall("malloc","pointer",["number"],[4*this.quiet.sampleBufferSize]),this.frame=e.ccall("malloc","pointer",["number"],[this.quiet.frameBufferSize]),void 0!==this.opts.onReceiverStatsUpdate&&e.ccall("quiet_decoder_enable_stats",null,["pointer"],[this.decoder]),this.inited=!0,this.lastChecksumFailCount=0,this.last_consume_times=[],this.num_consume_times=3}readbuf(){if(this.inited)for(;;){var t=e.ccall("quiet_decoder_recv","number",["pointer","pointer","number"],[this.decoder,this.frame,this.quiet.frameBufferSize]);if(-1===t)break;const i=e.HEAP8.slice(this.frame,this.frame+t);this.opts.onReceive(i.buffer)}}consume(){if(!this.inited)return;const t=Date.now();e.ccall("quiet_decoder_consume","number",["pointer","pointer","number"],[this.decoder,this.samples,this.quiet.sampleBufferSize]);const i=Date.now();this.last_consume_times.unshift(i-t),this.last_consume_times.length>this.num_consume_times&&this.last_consume_times.pop(),window.setTimeout((()=>{this.readbuf()}),0);const s=e.ccall("quiet_decoder_checksum_fails","number",["pointer"],[this.decoder]);if(setTimeout((()=>{s>this.lastChecksumFailCount&&(this.lastChecksumFailCount=s,this.opts.onReceiveFail?this.opts.onReceiveFail(s):console.error("onReceiveFail",s))}),0),this.opts.onReceiverStatsUpdate){var n=e.ccall("malloc","pointer",["number"],[4]),r=e.ccall("quiet_decoder_consume_stats","pointer",["pointer","pointer"],[this.decoder,n]),o=e.HEAPU32[n/4];e.ccall("free",null,["pointer"],[n]);for(var a=[],c=0;c<o;c++){var l=(r+20*c)/4,h=e.HEAPU32[l],u=e.HEAPU32[l+1];const t={errorVectorMagnitude:e.HEAPF32[l+2],receivedSignalStrengthIndicator:e.HEAPF32[l+3],symbols:[]};for(var p=0;p<u;p++){var m=(h+8*p)/4;t.symbols.push({real:e.HEAPF32[m],imag:e.HEAPF32[m+1]})}a.push(t)}this.opts.onReceiverStatsUpdate(a)}}initScriptProcessor(){if(this.inited)throw new Error("Not inited");const t=this.quiet.audioCtx.createScriptProcessor(this.quiet.sampleBufferSize,2,1);return this.idx=this.quiet.receivers_idx,this.quiet.receivers[this.idx]=this.scriptProcessor,this.quiet.receivers_idx++,t.onaudioprocess=t=>{if(this.inited){var i=t.inputBuffer.getChannelData(0);this.sample_view=e.HEAPF32.subarray(this.samples/4,this.samples/4+this.quiet.sampleBufferSize),this.sample_view.set(i),window.setTimeout((()=>{this.consume()}),0)}},t}destroy(){this.inited&&(this.scriptProcessor.disconnect(),e.ccall("free",null,["pointer"],[this.samples]),e.ccall("free",null,["pointer"],[this.frame]),delete this.quiet.receivers[this.idx],this.inited=!1)}getAverageDecodeTime(){if(0===this.last_consume_times.length)return 0;for(var e=0,t=0;t<this.last_consume_times.length;t++)e+=this.last_consume_times[t];return e/this.last_consume_times.length}}var l=i(729);class h extends l.EventEmitter{constructor(t){super(),this.running=!1,this.inited=!0,this.samplesToPlay=[],this.payload=[],this.samples=0,this.last_emit_times=[],this.num_emit_times=3,this.empties_written=0,this.playing=!1,this.paused=!1,this.opts=t,this.profileObj=t.profile,this.quiet=t.quiet,this.clampFrame=t.clampFrame,this.c_profiles=e.intArrayFromString(JSON.stringify({profile:this.profileObj})),this.c_profile=e.intArrayFromString("profile"),this.done=t.onFinish,this.opt=e.ccall("quiet_encoder_profile_str","pointer",["array","array"],[this.c_profiles,this.c_profile]),this.encoder=e.ccall("quiet_encoder_create","pointer",["pointer","number"],[this.opt,this.quiet.audioCtx.sampleRate]),e.ccall("free",null,["pointer"],[this.opt]),this.frame_len=0,this.clampFrame?this.frame_len=e.ccall("quiet_encoder_clamp_frame_len","number",["pointer","number"],[this.encoder,this.quiet.sampleBufferSize]):this.frame_len=e.ccall("quiet_encoder_get_frame_len","number",["pointer"],[this.encoder]),this.samples=e.ccall("malloc","pointer",["number"],[4*this.quiet.sampleBufferSize]),this.sample_view=e.HEAPF32.subarray(this.samples/4,this.samples/4+this.quiet.sampleBufferSize),this.emptySample=new Float32Array(this.sample_view.length),this.scriptNode=this.quiet.audioCtx.createScriptProcessor(this.quiet.sampleBufferSize,1,2),this.scriptNode.onaudioprocess=e=>{const t=e.outputBuffer.getChannelData(0);if(this.paused)t.set(this.emptySample);else{const e=this.samplesToPlay.shift();e?(this.playing||(this.emit("play-started"),this.playing=!0),t.set(e)):(this.playing&&(this.emit("play-stopped"),this.playing=!1),t.set(this.emptySample))}},this.dummy_osc=this.quiet.audioCtx.createOscillator(),this.dummy_osc.type="square",this.dummy_osc.frequency.value=420,this.mediaStreamDestination=this.quiet.audioCtx.createMediaStreamDestination(),this.stream=this.mediaStreamDestination.stream}pause(){this.paused=!0}resume(){this.paused=!1}async transmit(e){if(this.inited)if(e.byteLength){for(;!this.paused&&this.playing;)await new Promise((e=>{setTimeout(e,50)}));for(let t=0;t<e.byteLength;){const i=e.slice(t,t+this.frame_len);t+=i.byteLength,this.payload.push(i)}this.writebuf(),this.readBuf()}else console.error("empty message")}transmitText(e){const t=o(e);return this.transmit(t)}startTransmitter(){this.inited&&(this.inited=!0,this.dummy_osc.connect(this.scriptNode),this.scriptNode.connect(this.mediaStreamDestination),this.running=!0)}writebuf(){if(!this.inited)return;let t=!1,i=!1,s={send:0,emit:0};for(;;){const n=this.payload.shift();if(!n)break;if(t=!0,-1===e.ccall("quiet_encoder_send","number",["pointer","array","number"],[this.encoder,new Uint8Array(n),n.byteLength])){this.payload.unshift(n);break}s.send++,i=!0}if(!this.payload.length&&i&&void 0!==this.opts.onEnqueue)try{this.opts.onEnqueue()}catch(e){console.error(e)}t&&!this.running&&this.startTransmitter()}readBuf(){for(;;){const t=Date.now(),i=e.ccall("quiet_encoder_emit","number",["pointer","pointer","number"],[this.encoder,this.samples,this.quiet.sampleBufferSize]),s=Date.now();if(this.last_emit_times.unshift(s-t),this.last_emit_times.length>this.num_emit_times&&this.last_emit_times.pop(),-1===i){if(!(this.empties_written<1)){void 0!==this.done&&this.done(),this.running&&this.stopTransmitter();break}this.samplesToPlay.push(this.emptySample),this.empties_written++}else{this.empties_written=0;const e=new Float32Array(this.sample_view);if(i<this.quiet.sampleBufferSize)for(let t=i;t<this.quiet.sampleBufferSize;t++)e[t]=0;this.samplesToPlay.push(e)}}}stopTransmitter(){this.inited&&(this.running=!1)}}class u{constructor(e){this.emscriptenInitialized=!1,this.inited=!1,this.profiles={},this.frameBufferSize=Math.pow(2,14),this.receivers={},this.receivers_idx=0,this.sampleBufferSize=16384,window.AudioContext?this.audioCtx=new AudioContext(e):this.audioCtx=new webkitAudioContext(e)}async init(t){this.profiles=t.profiles,this.inited=!0,this.resume(),await async function(){if("INITED"!==p)return new Promise((t=>{if(m.push(t),"UNINIT"===p){p="INITING";const t=Date.now(),i=document.createElement("script");i.async=!0,i.src=e.locateFile("quiet-emscripten.js"),document.body.appendChild(i),e.onRuntimeInitialized=function(){p="INITED",console.log("onRuntimeInitialized",Date.now()-t),m.forEach((e=>{e()}))}}}))}()}async resume(){"suspended"===this.audioCtx.state&&await this.audioCtx.resume()}async transmitter(e){const t=e.onEnqueue||function(){console.log("transmitter.onEnqueue",...arguments)},i=e.onFinish||function(){console.log("transmitter.onFinish",...arguments)},s=this.profiles[e.profileName];if(!s)throw new Error(`Cannot find profile [${e.profileName}]. Available profileNames: ${Object.keys(this.profiles).join()}`);const n={profile:s,quiet:this,clampFrame:e.clampFrame,onEnqueue:t,onFinish:i};return new h(n)}async receiver(e){const t=e.audioStreams||[await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}})],i=e.onReceive||function(t){console.log("onReceive",e.profileName,r(t))},s=this.profiles[e.profileName];if(!s)throw new Error(`Cannot find profile [${e.profileName}]. Available profileNames: ${Object.keys(this.profiles).join()}`);const n={profile:s,audioStreams:t,quiet:this,onReceive:i,onReceiveFail:e.onReceiveFail,onReceiverStatsUpdate:e.onReceiverStatsUpdate};return n.quiet=this,new c(n)}}let p="UNINIT";const m=[]})(),s})()}));
//# sourceMappingURL=Quiet.js.map